import { DailyReport } from '../types/index';

// ÁîüÊàêÂÜÖËÅîCSSÊ†∑Âºè
function generateInlineCSS(): string {
  return `
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
        color: #f1f5f9;
        min-height: 100vh;
        padding: 20px;
        line-height: 1.6;
      }
      
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 16px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8), 
                    0 0 0 1px rgba(59, 130, 246, 0.1),
                    inset 0 1px 0 rgba(255, 255, 255, 0.1);
        overflow: hidden;
      }
      
      .header {
        background: linear-gradient(90deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%);
        border-bottom: 1px solid rgba(59, 130, 246, 0.3);
        padding: 40px;
        text-align: center;
        position: relative;
      }
      
      .header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, #3b82f6, #8b5cf6, #06b6d4);
      }
      
      .logo {
        width: 120px;
        height: auto;
        margin-bottom: 20px;
        filter: drop-shadow(0 4px 8px rgba(59, 130, 246, 0.3));
      }
      
      .title {
        font-size: 36px;
        font-weight: 700;
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 16px;
        text-shadow: 0 0 30px rgba(59, 130, 246, 0.5);
      }
      
      .subtitle {
        font-size: 18px;
        color: #94a3b8;
        margin-bottom: 8px;
      }
      
      .content {
        padding: 40px;
      }
      
      .summary-section {
        background: rgba(30, 41, 59, 0.8);
        border: 1px solid rgba(59, 130, 246, 0.2);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 32px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
      }
      
      .summary-title {
        font-size: 20px;
        font-weight: 600;
        color: #3b82f6;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .summary-title::before {
        content: 'üìä';
        font-size: 24px;
      }
      
      .summary-content {
        color: #cbd5e1;
        line-height: 1.8;
        font-size: 16px;
      }
      
      .category-section {
        margin-bottom: 40px;
        background: rgba(30, 41, 59, 0.4);
        border-radius: 12px;
        border: 1px solid rgba(59, 130, 246, 0.15);
        overflow: hidden;
      }
      
      .category-header {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(147, 51, 234, 0.2));
        padding: 20px 24px;
        border-bottom: 1px solid rgba(59, 130, 246, 0.3);
      }
      
      .category-title {
        font-size: 24px;
        font-weight: 600;
        color: #e2e8f0;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .category-news {
        padding: 24px;
      }
      
      .news-item {
        background: rgba(51, 65, 85, 0.6);
        border: 1px solid rgba(59, 130, 246, 0.2);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
        position: relative;
      }
      
      .news-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: linear-gradient(180deg, #3b82f6, #8b5cf6);
        border-radius: 2px 0 0 2px;
      }
      
      .news-item:hover {
        border-color: rgba(59, 130, 246, 0.4);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
      }
      
      .news-title {
        font-size: 18px;
        font-weight: 600;
        color: #f1f5f9;
        margin-bottom: 12px;
        line-height: 1.4;
      }
      
      .news-analysis {
        color: #cbd5e1;
        line-height: 1.7;
        font-size: 15px;
      }
      
      .footer {
        background: rgba(15, 23, 42, 0.8);
        border-top: 1px solid rgba(59, 130, 246, 0.3);
        padding: 24px 40px;
        text-align: center;
        color: #64748b;
        font-size: 14px;
      }
      
      /* ÂõæÊ†áÊ†∑Âºè */
      .icon-focus::before { content: 'üéØ'; }
      .icon-risk::before { content: '‚ö†Ô∏è'; }
      .icon-innovation::before { content: 'üöÄ'; }
      
      /* ÁßªÂä®Á´ØÂìçÂ∫îÂºèÊ†∑Âºè */
      @media (max-width: 768px) {
        body {
          padding: 10px;
          font-size: 14px;
        }
        
        .container {
          max-width: 100%;
          border-radius: 8px;
          margin: 0;
        }
        
        .header {
          padding: 20px 15px;
        }
        
        .logo {
          width: 80px;
          margin-bottom: 15px;
        }
        
        .title {
          font-size: 24px;
          margin-bottom: 12px;
        }
        
        .subtitle {
          font-size: 14px;
        }
        
        .content {
          padding: 20px 15px;
        }
        
        .summary-section {
          padding: 15px;
          margin-bottom: 20px;
        }
        
        .summary-title {
          font-size: 16px;
          margin-bottom: 12px;
        }
        
        .summary-content {
          font-size: 14px;
          line-height: 1.6;
        }
        
        .category-section {
          margin-bottom: 25px;
        }
        
        .category-header {
          padding: 15px;
        }
        
        .category-title {
          font-size: 18px;
          gap: 8px;
        }
        
        .category-news {
          padding: 15px;
        }
        
        .news-item {
          padding: 15px;
          margin-bottom: 15px;
        }
        
        .news-title {
          font-size: 16px;
          margin-bottom: 10px;
          line-height: 1.3;
        }
        
        .news-analysis {
          font-size: 13px;
          line-height: 1.5;
        }
        
        .footer {
          padding: 15px;
          font-size: 12px;
        }
      }
      
      /* Â∞èÂ±èÂπï‰ºòÂåñ */
      @media (max-width: 480px) {
        body {
          padding: 5px;
          font-size: 13px;
        }
        
        .container {
          border-radius: 4px;
        }
        
        .header {
          padding: 15px 10px;
        }
        
        .logo {
          width: 60px;
        }
        
        .title {
          font-size: 20px;
        }
        
        .content {
          padding: 15px 10px;
        }
        
        .summary-section,
        .category-header,
        .category-news {
          padding: 12px;
        }
        
        .news-item {
          padding: 12px;
        }
        
        .news-title {
          font-size: 15px;
        }
        
        .news-analysis {
          font-size: 12px;
        }
      }
      
      /* ÊâìÂç∞Ê†∑Âºè */
      @media print {
        body {
          background: white;
          color: black;
          padding: 0;
          font-size: 12px;
        }
        
        .container {
          box-shadow: none;
          border: none;
          background: white;
          max-width: 100%;
        }
        
        .header {
          background: #f8f9fa;
          border-bottom: 2px solid #dee2e6;
          padding: 20px;
        }
        
        .title {
          color: #2563eb !important;
          -webkit-text-fill-color: #2563eb !important;
        }
        
        .summary-section,
        .category-section,
        .news-item {
          background: white;
          border: 1px solid #dee2e6;
          color: black;
        }
        
        .summary-title,
        .category-title {
          color: #2563eb;
        }
        
        .news-title {
          color: #1f2937;
        }
        
        .news-analysis,
        .summary-content {
          color: #374151;
        }
        
        .content {
          padding: 20px;
        }
      }
    </style>
  `;
}

// ÁîüÊàêHTMLÊñáÊ°£
export function generateHTMLReport(report: DailyReport): string {
  // ÂàÜÁ±ªÊò†Â∞ÑÔºö‰ªéËã±ÊñákeyÂà∞‰∏≠ÊñáÊ†áÈ¢ò
  const categoryMapping: { [key: string]: string } = {
    'focus': 'ÁÑ¶ÁÇπÂÆâÂÖ®‰∫ã‰ª∂',
    'risk': 'ÈáçÂ§ßÈ£éÈô©‰∏éÈ¢ÑË≠¶', 
    'innovation': '‰∫ß‰∏öÂàõÊñ∞‰∏éÊîøÁ≠ñ'
  };

  const categoryIcons: { [key: string]: string } = {
    'ÁÑ¶ÁÇπÂÆâÂÖ®‰∫ã‰ª∂': 'icon-focus',
    'ÈáçÂ§ßÈ£éÈô©‰∏éÈ¢ÑË≠¶': 'icon-risk',
    '‰∫ß‰∏öÂàõÊñ∞‰∏éÊîøÁ≠ñ': 'icon-innovation'
  };

  // ÊåâÂàÜÁ±ªÁªÑÁªáÊñ∞Èóª
  const categorizedNews: { [key: string]: typeof report.news } = {
    'ÁÑ¶ÁÇπÂÆâÂÖ®‰∫ã‰ª∂': [],
    'ÈáçÂ§ßÈ£éÈô©‰∏éÈ¢ÑË≠¶': [],
    '‰∫ß‰∏öÂàõÊñ∞‰∏éÊîøÁ≠ñ': []
  };

  report.news.forEach(newsItem => {
    const chineseCategory = categoryMapping[newsItem.category] || newsItem.category;
    if (categorizedNews[chineseCategory]) {
      categorizedNews[chineseCategory].push(newsItem);
    }
  });

  const categorySections = Object.entries(categorizedNews)
    .filter(([_, news]) => news.length > 0)
    .map(([category, news]) => {
      const newsItems = news.map(item => `
        <div class="news-item">
          <div class="news-title">${item.title}</div>
          <div class="news-analysis"><strong>ÂàÜÊûê‰∏éÂΩ±ÂìçÔºö</strong> ${item.content}</div>
        </div>
      `).join('');

      return `
        <div class="category-section">
          <div class="category-header">
            <h2 class="category-title ${categoryIcons[category]}">${category}</h2>
          </div>
          <div class="category-news">
            ${newsItems}
          </div>
        </div>
      `;
    }).join('');

  return `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Êµ∑‰πãÂÆâÂÆâÂÖ®ÊØèÊó•Âø´Êä• - ${report.date} - Á¨¨${report.issue}Êúü</title>
  ${generateInlineCSS()}
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="./ocean_security_logo.png" alt="Ocean Security Logo" class="logo">
      <h1 class="title">Êµ∑‰πãÂÆâÂÆâÂÖ®ÊØèÊó•Âø´Êä•</h1>
      <div class="subtitle">${report.date} ¬∑ Á¨¨${report.issue}Êúü</div>
    </div>
    
    <div class="content">
      ${report.summary ? `
        <div class="summary-section">
          <h2 class="summary-title">‰ªäÊó•ÊëòË¶Å</h2>
          <div class="summary-content">${report.summary}</div>
        </div>
      ` : ''}
      
      ${categorySections}
    </div>
    
    <div class="footer">
      <p>¬© ${new Date().getFullYear()} Ocean Security ¬∑ Êµ∑‰πãÂÆâÂÆâÂÖ®ÊØèÊó•Âø´Êä•</p>
      <p>Generated on ${new Date().toLocaleString('zh-CN')}</p>
    </div>
  </div>
</body>
</html>
  `.trim();
}

// Êó•ÊúüÊ†ºÂºèÂåñÂáΩÊï∞ÔºöÂ∞ÜÊó•ÊúüËΩ¨Êç¢‰∏∫YYYYMMDDÊ†ºÂºè
function formatDateToFileName(dateStr: string): string {
  try {
    // Â∞ùËØïÂ§öÁßçÊó•ÊúüÊ†ºÂºè
    let date: Date;
    
    // Â§ÑÁêÜ‰∏≠ÊñáÊó•ÊúüÊ†ºÂºèÔºö"2025Âπ¥7Êúà21Êó•"
    if (dateStr.includes('Âπ¥') && dateStr.includes('Êúà') && dateStr.includes('Êó•')) {
      const match = dateStr.match(/(\d{4})Âπ¥(\d{1,2})Êúà(\d{1,2})Êó•/);
      if (match) {
        const year = match[1];
        const month = match[2].padStart(2, '0');
        const day = match[3].padStart(2, '0');
        return `${year}${month}${day}`;
      }
    }
    
    // Â§ÑÁêÜISOÊó•ÊúüÊ†ºÂºèÔºö"2025-07-21"
    if (dateStr.includes('-')) {
      date = new Date(dateStr);
    } else {
      // Â§ÑÁêÜÂÖ∂‰ªñÊ†ºÂºè
      date = new Date(dateStr);
    }
    
    if (isNaN(date.getTime())) {
      // Â¶ÇÊûúÊó•ÊúüËß£ÊûêÂ§±Ë¥•Ôºå‰ΩøÁî®ÂΩìÂâçÊó•Êúü
      date = new Date();
    }
    
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    
    return `${year}${month}${day}`;
  } catch (error) {
    console.warn('Êó•ÊúüËß£ÊûêÂ§±Ë¥•Ôºå‰ΩøÁî®ÂΩìÂâçÊó•Êúü:', error);
    const now = new Date();
    const year = now.getFullYear();
    const month = (now.getMonth() + 1).toString().padStart(2, '0');
    const day = now.getDate().toString().padStart(2, '0');
    return `${year}${month}${day}`;
  }
}

// Ëß¶ÂèëHTMLÊñá‰ª∂‰∏ãËΩΩ
export function downloadHTMLReport(report: DailyReport): void {
  console.log('ÂºÄÂßãÁîüÊàêHTML‰∏ãËΩΩ...');
  console.log('Êä•ÂëäÊï∞ÊçÆ:', report);
  
  try {
    const htmlContent = generateHTMLReport(report);
    console.log('HTMLÂÜÖÂÆπÁîüÊàêÊàêÂäüÔºåÈïøÂ∫¶:', htmlContent.length);
    
    const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
    console.log('BlobÂØπË±°ÂàõÂª∫ÊàêÂäüÔºåÂ§ßÂ∞è:', blob.size);
    
    // ÁîüÊàêÊñá‰ª∂ÂêçÔºönews + YYYYMMDD.html
    const dateFormatted = formatDateToFileName(report.date);
    const fileName = `news${dateFormatted}.html`;
    console.log('ÁîüÊàêÊñá‰ª∂Âêç:', fileName);
    
    // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = fileName;
    console.log('‰∏ãËΩΩÈìæÊé•ÂàõÂª∫ÊàêÂäü:', link.href);
    
    // Ê£ÄÊü•ÊµèËßàÂô®ÊîØÊåÅ
    if (link.download !== undefined) {
      console.log('ÊµèËßàÂô®ÊîØÊåÅdownloadÂ±ûÊÄß');
    } else {
      console.warn('ÊµèËßàÂô®‰∏çÊîØÊåÅdownloadÂ±ûÊÄß');
    }
    
    // Ëß¶Âèë‰∏ãËΩΩ
    document.body.appendChild(link);
    console.log('ÈìæÊé•Â∑≤Ê∑ªÂä†Âà∞DOM');
    
    link.click();
    console.log('Â∑≤Ëß¶ÂèëÁÇπÂáª‰∫ã‰ª∂');
    
    document.body.removeChild(link);
    console.log('ÈìæÊé•Â∑≤‰ªéDOMÁßªÈô§');
    
    // Ê∏ÖÁêÜURLÂØπË±°
    URL.revokeObjectURL(link.href);
    console.log('URLÂØπË±°Â∑≤Ê∏ÖÁêÜ');
    
    console.log(`‚úÖ HTMLÂø´Êä•Â∑≤ÁîüÊàêÂπ∂‰∏ãËΩΩ: ${fileName}`);
    
    // Ê∑ªÂä†Áî®Êà∑ÊèêÁ§∫
    if (typeof window !== 'undefined' && window.alert) {
      setTimeout(() => {
        alert(`Âø´Êä•Â∑≤‰∏ãËΩΩ: ${fileName}\nËØ∑Ê£ÄÊü•ÊµèËßàÂô®ÁöÑ‰∏ãËΩΩÊñá‰ª∂Â§π„ÄÇ`);
      }, 100);
    }
    
  } catch (error) {
    console.error('‚ùå HTML‰∏ãËΩΩÂ§±Ë¥•:', error);
    if (typeof window !== 'undefined' && window.alert) {
      alert('‰∏ãËΩΩÂ§±Ë¥•ÔºåËØ∑Êü•ÁúãÊéßÂà∂Âè∞‰∫ÜËß£ËØ¶ÁªÜÈîôËØØ‰ø°ÊÅØ„ÄÇ');
    }
  }
}